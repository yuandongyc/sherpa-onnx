name: a-ffmpeg-examples-windows

on:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/a-ffmpeg-examples-windows.yaml'
      - 'cmake/**'
      - 'sherpa-onnx/csrc/*'
      - 'sherpa-onnx/c-api/*'
      - 'ffmpeg-examples-windows/**'

  workflow_dispatch:

concurrency:
  group: a-ffmpeg-examples-windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version
        shell: bash
        run: |
          ./new-release.sh
          git diff .

      - name: Cache FFmpeg
        uses: actions/cache@v4
        with:
          path: ffmpeg
          key: ffmpeg-dev-windows-v2-${{ hashFiles('.github/workflows/a-ffmpeg-examples-windows.yaml') }}
          restore-keys: |
            ffmpeg-dev-windows-v2-

      - name: Download FFmpeg dev
        shell: pwsh
        run: |
          if (-not (Test-Path "ffmpeg")) {
            Write-Host "Downloading FFmpeg dev package..."
            # 使用 BtbN 的自动构建版本
            $url = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
            Invoke-WebRequest -Uri $url -OutFile "ffmpeg.zip"
            Expand-Archive -Path "ffmpeg.zip" -DestinationPath "." -Force
            Remove-Item "ffmpeg.zip"
            
            # 重命名解压后的目录为 ffmpeg
            Rename-Item -Path "ffmpeg-master-latest-win64-gpl-shared" -NewName "ffmpeg" -Force
            
            Write-Host "FFmpeg downloaded and extracted successfully"
          } else {
            Write-Host "FFmpeg cache hit"
          }
          Write-Host "FFmpeg directory structure:"
          Get-ChildItem ffmpeg | ForEach-Object { Write-Host $_.Name }
          
          Write-Host "FFmpeg include directory contents:"
          if (Test-Path "ffmpeg/include") {
            Get-ChildItem ffmpeg/include -Recurse | ForEach-Object { Write-Host $_.FullName }
          } else {
            Write-Host "ffmpeg/include not found!"
            Write-Host "Looking for include directory..."
            Get-ChildItem ffmpeg -Recurse -Filter "avcodec.h" | ForEach-Object { Write-Host "Found: $($_.FullName)" }
          }
          
          Write-Host "FFmpeg lib directory:"
          Get-ChildItem ffmpeg/lib -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.Name }

      - name: Build sherpa-onnx
        shell: pwsh
        run: |
          cmake --version
          
          mkdir build
          cd build
          
          $ffmpegInclude = "$env:GITHUB_WORKSPACE\ffmpeg\include"
          $ffmpegLib = "$env:GITHUB_WORKSPACE\ffmpeg\lib"
          Write-Host "FFMPEG_INCLUDE_DIR: $ffmpegInclude"
          Write-Host "FFMPEG_LIBRARIES: $ffmpegLib"
          
          # 验证 FFmpeg 路径是否存在
          if (-not (Test-Path $ffmpegInclude)) {
            Write-Error "FFmpeg include directory not found: $ffmpegInclude"
            exit 1
          }
          if (-not (Test-Path $ffmpegLib)) {
            Write-Error "FFmpeg lib directory not found: $ffmpegLib"
            exit 1
          }
          
          Write-Host "Running CMake configuration..."
          & cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -D CMAKE_BUILD_TYPE=Release `
            -D BUILD_SHARED_LIBS=ON `
            -D CMAKE_INSTALL_PREFIX=./install `
            -D SHERPA_ONNX_ENABLE_BINARY=OFF `
            -D SHERPA_ONNX_ENABLE_C_API=ON `
            -D SHERPA_ONNX_BUILD_FFMPEG_EXAMPLES_WINDOWS=ON `
            -D FFMPEG_INCLUDE_DIR="$ffmpegInclude" `
            -D FFMPEG_LIBRARIES="$ffmpegLib"
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "CMake configuration failed with exit code $LASTEXITCODE"
            exit 1
          }
          
          Write-Host "CMake configuration complete. Building sherpa-onnx-c-api first..."
          & cmake --build . --config Release --target sherpa-onnx-c-api --parallel 2
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Failed to build sherpa-onnx-c-api"
            exit 1
          }
          
          Write-Host "Building sherpa-onnx-ffmpeg target with verbose output..."
          & cmake --build . --config Release --target sherpa-onnx-ffmpeg --parallel 2 --verbose 2>&1 | Tee-Object -FilePath ffmpeg-build.log
          $ffmpegExitCode = $LASTEXITCODE
          
          if ($ffmpegExitCode -ne 0) {
            Write-Error "Failed to build sherpa-onnx-ffmpeg with exit code $ffmpegExitCode"
            Write-Host "=== Full build log ==="
            Get-Content ffmpeg-build.log -ErrorAction SilentlyContinue | Select-Object -Last 100
            Write-Host "=== Searching for include paths in build log ==="
            Select-String -Path ffmpeg-build.log -Pattern "\/I|include|libavcodec" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.Line }
            exit 1
          }
          
          Write-Host "Build complete. Checking output files..."
          Write-Host "All .exe files in build directory:"
          Get-ChildItem ..\build -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
          
          if (-not (Test-Path "..\build\bin\Release\sherpa-onnx-ffmpeg.exe")) {
            Write-Error "sherpa-onnx-ffmpeg.exe not found at expected location: build\bin\Release\sherpa-onnx-ffmpeg.exe"
            Write-Host "Contents of build\bin:"
            Get-ChildItem ..\build\bin -Recurse -ErrorAction SilentlyContinue
            exit 1
          }
          
          Write-Host "Installing..."
          & cmake --install . --config Release
          
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Install failed with exit code $LASTEXITCODE"
            exit 1
          }

      - name: Download test model
        shell: pwsh
        run: |
          Write-Host "Downloading test model..."
          $url = "https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20.tar.bz2"
          Invoke-WebRequest -Uri $url -OutFile "model.tar.bz2"
          
          Write-Host "Extracting model..."
          tar -xf model.tar.bz2
          Remove-Item "model.tar.bz2"
          
          Get-ChildItem sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20

      - name: Find sherpa-onnx-ffmpeg executable
        shell: pwsh
        run: |
          Write-Host "Searching for sherpa-onnx-ffmpeg.exe..."
          $exePath = "build\bin\Release\sherpa-onnx-ffmpeg.exe"
          if (Test-Path $exePath) {
            Write-Host "Found: $exePath"
            echo "FFMPEG_EXE=$exePath" >> $env:GITHUB_ENV
          } else {
            Write-Host "sherpa-onnx-ffmpeg.exe not found at $exePath"
            Write-Host "Searching entire build directory..."
            Get-ChildItem build -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Test sherpa-onnx-ffmpeg (greedy_search)
        shell: pwsh
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\build\install\bin;$env:PATH"
          
          & $env:FFMPEG_EXE `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\tokens.txt `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\encoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\decoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\joiner-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\test_wavs\0.wav `
            2 `
            greedy_search

      - name: Test sherpa-onnx-ffmpeg (modified_beam_search)
        shell: pwsh
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\build\install\bin;$env:PATH"
          
          & $env:FFMPEG_EXE `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\tokens.txt `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\encoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\decoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\joiner-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\test_wavs\0.wav `
            2 `
            modified_beam_search

      - name: Test URL decoding
        shell: pwsh
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\build\install\bin;$env:PATH"
          
          & $env:FFMPEG_EXE `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\tokens.txt `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\encoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\decoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\joiner-epoch-99-avg-1.onnx `
            https://huggingface.co/csukuangfj/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20/resolve/main/test_wavs/3.wav

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sherpa-onnx-ffmpeg-windows
          path: |
            ${{ env.FFMPEG_EXE }}
            ffmpeg-examples-windows/README.md
            ffmpeg-examples-windows/run.ps1
          retention-days: 90

      - name: Clean up
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20
          Remove-Item -Recurse -Force build
