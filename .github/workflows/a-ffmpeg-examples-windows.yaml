name: a-ffmpeg-examples-windows

on:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/a-ffmpeg-examples-windows.yaml'
      - 'cmake/**'
      - 'sherpa-onnx/csrc/*'
      - 'sherpa-onnx/c-api/*'
      - 'ffmpeg-examples-windows/**'

  workflow_dispatch:

concurrency:
  group: a-ffmpeg-examples-windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build_windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update version
        shell: bash
        run: |
          ./new-release.sh
          git diff .

      - name: Cache FFmpeg
        uses: actions/cache@v4
        with:
          path: ffmpeg
          key: ffmpeg-dev-windows-${{ hashFiles('.github/workflows/a-ffmpeg-examples-windows.yaml') }}
          restore-keys: |
            ffmpeg-dev-windows-

      - name: Download FFmpeg dev
        shell: pwsh
        run: |
          if (-not (Test-Path "ffmpeg")) {
            Write-Host "Downloading FFmpeg dev package..."
            # 使用 BtbN 的自动构建版本
            $url = "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl-shared.zip"
            Invoke-WebRequest -Uri $url -OutFile "ffmpeg.zip"
            Expand-Archive -Path "ffmpeg.zip" -DestinationPath "." -Force
            Remove-Item "ffmpeg.zip"
            
            # 重命名解压后的目录为 ffmpeg
            Rename-Item -Path "ffmpeg-master-latest-win64-gpl-shared" -NewName "ffmpeg" -Force
            
            Write-Host "FFmpeg downloaded and extracted successfully"
          } else {
            Write-Host "FFmpeg cache hit"
          }
          Write-Host "FFmpeg directory structure:"
          Get-ChildItem ffmpeg -Recurse | Select-Object -First 30
          Write-Host "FFmpeg include directory:"
          Get-ChildItem ffmpeg/include -ErrorAction SilentlyContinue
          Write-Host "FFmpeg lib directory:"
          Get-ChildItem ffmpeg/lib -ErrorAction SilentlyContinue

      - name: Build sherpa-onnx
        shell: pwsh
        run: |
          cmake --version
          
          mkdir build
          cd build
          
          $ffmpegInclude = "$env:GITHUB_WORKSPACE\ffmpeg\include"
          $ffmpegLib = "$env:GITHUB_WORKSPACE\ffmpeg\lib"
          Write-Host "FFMPEG_INCLUDE_DIR: $ffmpegInclude"
          Write-Host "FFMPEG_LIBRARIES: $ffmpegLib"
          
          cmake .. `
            -G "Visual Studio 17 2022" `
            -A x64 `
            -D CMAKE_BUILD_TYPE=Release `
            -D BUILD_SHARED_LIBS=ON `
            -D CMAKE_INSTALL_PREFIX=./install `
            -D SHERPA_ONNX_ENABLE_BINARY=OFF `
            -D SHERPA_ONNX_BUILD_FFMPEG_EXAMPLES_WINDOWS=ON `
            -D FFMPEG_INCLUDE_DIR="$ffmpegInclude" `
            -D FFMPEG_LIBRARIES="$ffmpegLib" 2>&1 | Tee-Object -FilePath cmake.log
          
          Write-Host "CMake configuration complete."
          Write-Host "Checking CMake output for FFmpeg..."
          Select-String -Path cmake.log -Pattern "FFMPEG|ffmpeg" | Select-Object -Last 20
          
          Write-Host "Building all targets..."
          cmake --build . --config Release --parallel 2
          
          Write-Host "Checking build output..."
          Get-ChildItem bin -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*.exe" }
          Get-ChildItem bin/Release -ErrorAction SilentlyContinue | Where-Object { $_.Name -like "*.dll" }
          
          cmake --install . --config Release
          
          Get-ChildItem install/lib -ErrorAction SilentlyContinue
          Get-ChildItem install/include -ErrorAction SilentlyContinue

      - name: Download test model
        shell: pwsh
        run: |
          Write-Host "Downloading test model..."
          $url = "https://github.com/k2-fsa/sherpa-onnx/releases/download/asr-models/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20.tar.bz2"
          Invoke-WebRequest -Uri $url -OutFile "model.tar.bz2"
          
          Write-Host "Extracting model..."
          tar -xf model.tar.bz2
          Remove-Item "model.tar.bz2"
          
          Get-ChildItem sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20

      - name: Find sherpa-onnx-ffmpeg executable
        shell: pwsh
        run: |
          Write-Host "Searching for sherpa-onnx-ffmpeg.exe..."
          $exe = Get-ChildItem -Path build -Name "sherpa-onnx-ffmpeg.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            $fullPath = Join-Path "build" $exe
            Write-Host "Found: $fullPath"
            $env:FFMPEG_EXE = $fullPath
            echo "FFMPEG_EXE=$fullPath" >> $env:GITHUB_ENV
          } else {
            Write-Host "sherpa-onnx-ffmpeg.exe not found!"
            Get-ChildItem build -Recurse | Where-Object { $_.Name -like "*.exe" }
            exit 1
          }

      - name: Test sherpa-onnx-ffmpeg (greedy_search)
        shell: pwsh
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\build\install\bin;$env:PATH"
          
          & $env:FFMPEG_EXE `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\tokens.txt `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\encoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\decoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\joiner-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\test_wavs\0.wav `
            2 `
            greedy_search

      - name: Test sherpa-onnx-ffmpeg (modified_beam_search)
        shell: pwsh
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\build\install\bin;$env:PATH"
          
          & $env:FFMPEG_EXE `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\tokens.txt `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\encoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\decoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\joiner-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\test_wavs\0.wav `
            2 `
            modified_beam_search

      - name: Test URL decoding
        shell: pwsh
        run: |
          $env:PATH = "$env:GITHUB_WORKSPACE\build\install\bin;$env:PATH"
          
          & $env:FFMPEG_EXE `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\tokens.txt `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\encoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\decoder-epoch-99-avg-1.onnx `
            .\sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20\joiner-epoch-99-avg-1.onnx `
            https://huggingface.co/csukuangfj/sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20/resolve/main/test_wavs/3.wav

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sherpa-onnx-ffmpeg-windows
          path: |
            ${{ env.FFMPEG_EXE }}
            ffmpeg-examples-windows/README.md
            ffmpeg-examples-windows/run.ps1
          retention-days: 90

      - name: Clean up
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force sherpa-onnx-streaming-zipformer-bilingual-zh-en-2023-02-20
          Remove-Item -Recurse -Force build
